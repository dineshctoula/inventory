{% extends 'dairyapp/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block extra-css %}
<style>
    .myfont{
        font-size: 18px;
    }
</style>
{% endblock %}

{% block main-content %}
    <div class="row myfont" style="padding-left: 15px;">
        <div class="col-lg-4">
            <h2><strong>Sell Products सामन बिक्री</strong></h2>

            <form class="form-horizontal" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                {{ form.non_field_errors }}

                {% for hidden_field in form.hidden_fields %}
                    {{ hidden_field }}
                {% endfor %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                {% endif %}

                {% for field in form %}
                    <div class="form-group">
                        {{ field.label_tag }}
                        {% if form.is_bound %}
                            {% if field.errors %}
                                {% render_field field class="form-control is-invalid"%}
                                {% for error in field.errors %}
                                    <div class="invalid-feedback text-danger">
                                         {{ error }}
                                    </div>
                                {% endfor %}
                            {% else %}
                                   {% render_field field class="form-control is-valid" %}
                            {% endif %}
                        {% else %}
                               {% render_field field class="form-control" %}
                        {% endif %}

                        {% if field.help_text %}
                            <small class="form-text text-primary">{{ field.help_text }}</small>
                        {% endif %}
                        {% if field.name == 'buyer_name' %}
                            <a href="{% url 'dairyapp:sellers' %}" class="btn btn-sm btn-link" style="padding: 0; margin-top: 5px;">
                                <i class="fa fa-plus"></i> Add New Buyer
                            </a>
                        {% endif %}
                    </div>
                {% endfor %}

                <div class="form-group">
                    <div class="col-sm-12">
                         <button type="submit" class="btn btn-primary btn-block">
                             <strong>Add Sale</strong>
                         </button>
                    </div>
                 </div>

                {% if messages %}
                  <ul class="messages">
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }}">
                         <a class="close" href="#" data-dismiss="alert">×</a>
                        <li class="text-danger">{{ message }}</li>
                        </div>
                    {% endfor %}
                  </ul>
                {% endif %}
            </form>
        </div>

        <div class="col-lg-8">
            <h2>Showing Latest Sales सामन बिक्री</h2>

            <div class="table-responsive" style="overflow-x: auto;">
              <table class="table table-striped table-hover table-responsive" style="font-size: 12px;">
                <thead>
                  <tr class="bg-success">
                    <th>SN.</th>
                    <th>Date</th>
                    <th>Buyer</th>
                    <th>Product</th>
                    <th>Qty L.</th>
                    <th>Fat</th>
                    <th>SNF</th>
                    <th>Fat/Kg.</th>
                    <th>SNF/Kg.</th>
                    <th>Rate</th>
                    <th>TS</th>
                    <th>Ts Amount</th>
                    <th>Rate/ltr</th>
                    <th>Total Amount</th>
                    <th>Advance</th>
                    <th>Remaining</th>
                    <th>Remarks</th>
                    <th>Actions</th>
                  </tr>
                </thead>

                <tbody class="active">
                    {% for sale in sales %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ sale.mProductSell_date|date:"d/m/Y" }}</td>
                            <td>{{ sale.buyer_name }}</td>
                            <td>{{ sale.milk_product }}</td>
                            <td>{{ sale.mProductSell_qty|floatformat:2 }}</td>
                            <td>{% if sale.fat %}{{ sale.fat|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if sale.snf %}{{ sale.snf|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if sale.fat_per_kg %}{{ sale.fat_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if sale.snf_per_kg %}{{ sale.snf_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if sale.rate %}{{ sale.rate|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if sale.ts %}{{ sale.ts|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if sale.ts_amount %}{{ sale.ts_amount|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if sale.rate_per_ltr %}{{ sale.rate_per_ltr|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{{ sale.mProductSell_amount|floatformat:2 }}</td>
                            <td>{% if sale.advance_amount %}{{ sale.advance_amount|floatformat:2 }}{% else %}0.00{% endif %}</td>
                            <td>
                                <span class="{% if sale.remaining_balance > 0 %}text-danger{% elif sale.remaining_balance < 0 %}text-success{% else %}text-muted{% endif %}" style="font-weight: bold;">
                                    {{ sale.remaining_balance|floatformat:2 }}
                                </span>
                            </td>
                            <td style="max-width: 150px; word-wrap: break-word; font-size: 11px;">
                                {% if sale.remarks %}{{ sale.remarks|truncatewords:10 }}{% else %}-{% endif %}
                            </td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <button type="button" class="btn btn-info btn-sm print-sale-btn" data-sale-id="{{ sale.mProductSell_id }}" title="Print">
                                        <i class="fa fa-print"></i> Print
                                    </button>
                                    <a class="btn btn-danger btn-sm" href="{% url 'dairyapp:delete-sales' id=sale.mProductSell_id %}" onclick="return confirm('Do you want to confirm?')" title="Delete">
                                        <i class="fa fa-times"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    {% if sales and totals %}
                    <tr class="bg-warning" style="font-weight: bold;">
                        <td colspan="4"><strong>Total</strong></td>
                        <td><strong>{{ totals.total_qty|floatformat:2 }}</strong></td>
                        <td colspan="2">-</td>
                        <td colspan="2">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td><strong>{{ totals.total_ts_amount|floatformat:2 }}</strong></td>
                        <td>-</td>
                        <td><strong>{{ totals.total_amount|floatformat:2 }}</strong></td>
                        <td><strong>{{ totals.total_advance|floatformat:2 }}</strong></td>
                        <td>-</td>
                        <td>-</td>
                        <td></td>
                    </tr>
                    {% endif %}
                </tbody>
              </table>
            </div>

            {% if sales.has_other_pages %}
                <ul class="pagination">
                    {% if sales.has_previous %}
                        <li>
                            <a href="?page={{ sales.previous_page_number }}">&laquo;</a>
                        </li>
                    {% else %}
                        <li class="disabled">
                            <span>&laquo;</span>
                        </li>
                    {% endif %}
                    {% for i in sales.paginator.page_range %}
                        {% if sales.number == i %}
                            <li class="active">
                                <span>{{ i }}
                                <span class="sr-only">(current)</span>
                                </span>
                            </li>
                        {% else %}
                            <li>
                                <a href="?page={{ i }}">{{ i }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if sales.has_next %}
                        <li>
                            <a href="?page={{ sales.next_page_number }}">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="disabled">
                            <span>&raquo;</span>
                        </li>
                    {% endif %}
                </ul>
            {% endif %}
        </div>
    </div>

    <!-- Print content for each sale record -->
    {% for sale in sales %}
    <div id="printContent-{{ sale.mProductSell_id }}" class="print-content" style="display: none;">
        <div class="ticket-slip">
            <div class="ticket-header">
                <div class="ticket-title">प्रेक्षा प्रशिक्षा दूध डेरी</div>
                <div class="ticket-subtitle"> RECEIPT</div>
            </div>
            
            <div class="ticket-divider">--------------------------------</div>
            
            <div class="ticket-content">
                <div class="ticket-row">
                    <span class="ticket-label">ID:</span>
                    <span class="ticket-value">#{{ sale.mProductSell_id }}</span>
                </div>
                
                <div class="ticket-row">
                    <span class="ticket-label">Date:</span>
                    <span class="ticket-value">{{ sale.mProductSell_date|date:"d/m/Y" }}</span>
                </div>
                
                <div class="ticket-divider">--------------------------------</div>
                
                <div class="ticket-row highlight">
                    <span class="ticket-label">Buyer:</span>
                    <span class="ticket-value-bold">{{ sale.buyer_name }}</span>
                </div>
                
                <div class="ticket-row">
                    <span class="ticket-label">Product:</span>
                    <span class="ticket-value">{{ sale.milk_product }}</span>
                </div>
                
                <div class="ticket-row">
                    <span class="ticket-label">Qty (Liters):</span>
                    <span class="ticket-value">{{ sale.mProductSell_qty|floatformat:2 }}</span>
                </div>
                
                {% if sale.fat %}
                <div class="ticket-row">
                    <span class="ticket-label">Fat (%):</span>
                    <span class="ticket-value">{{ sale.fat|floatformat:2 }}</span>
                </div>
                {% endif %}
                
                {% if sale.snf %}
                <div class="ticket-row">
                    <span class="ticket-label">SNF (%):</span>
                    <span class="ticket-value">{{ sale.snf|floatformat:2 }}</span>
                </div>
                {% endif %}
                
                {% if sale.fat_per_kg %}
                <div class="ticket-row">
                    <span class="ticket-label">Fat/Kg:</span>
                    <span class="ticket-value">{{ sale.fat_per_kg|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                {% if sale.snf_per_kg %}
                <div class="ticket-row">
                    <span class="ticket-label">SNF/Kg:</span>
                    <span class="ticket-value">{{ sale.snf_per_kg|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                {% if sale.rate %}
                <div class="ticket-row">
                    <span class="ticket-label">Rate:</span>
                    <span class="ticket-value">{{ sale.rate|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                {% if sale.ts %}
                <div class="ticket-row">
                    <span class="ticket-label">TS:</span>
                    <span class="ticket-value">{{ sale.ts|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                {% if sale.ts_amount %}
                <div class="ticket-row">
                    <span class="ticket-label">TS Amount:</span>
                    <span class="ticket-value">NRs. {{ sale.ts_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                
                {% if sale.rate_per_ltr %}
                <div class="ticket-row">
                    <span class="ticket-label">Rate/Ltr:</span>
                    <span class="ticket-value">NRs. {{ sale.rate_per_ltr|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                <div class="ticket-divider">--------------------------------</div>
                
                <div class="ticket-row balance-row">
                    <span class="ticket-label">Total Amount:</span>
                    <span class="ticket-value-balance">NRs. {{ sale.mProductSell_amount|floatformat:2 }}</span>
                </div>
                
                {% if sale.advance_amount %}
                <div class="ticket-row">
                    <span class="ticket-label">Advance:</span>
                    <span class="ticket-value">NRs. {{ sale.advance_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                
                {% if sale.remarks %}
                <div class="ticket-divider">--------------------------------</div>
                <div class="ticket-row">
                    <span class="ticket-label">Remarks:</span>
                    <span class="ticket-value-small">{{ sale.remarks }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="ticket-divider">--------------------------------</div>
            
            <div class="ticket-footer">
                <div class="ticket-date">Printed: <span id="printDate-{{ sale.mProductSell_id }}"></span></div>
                <div class="ticket-thank">Thank You!</div>
            </div>
            
            <div class="ticket-cut-line">━━━━━━━━━━━━━━━━━━━━━━━━━━</div>
        </div>
    </div>
    {% endfor %}

{% endblock %}

{% block extra-js %}
<script>
    $('#nepalicalendar_sell').nepaliDatePicker({
        onFocus: false,
        ndpTriggerButton: true,
        ndpTriggerButtonText: 'Date',
        npdMonth: true,
        npdYearCount: 10,
        ndpTriggerButtonClass: 'btn btn-primary btn-sm',
        disableDaysAfter: '1'
    });
    
    function printSaleRecord(saleId) {
        var printContent = document.getElementById('printContent-' + saleId);
        var printDate = document.getElementById('printDate-' + saleId);
        
        if (!printContent) {
            alert('Print content not found!');
            return;
        }
        
        if (printDate) {
            var now = new Date();
            var dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            printDate.textContent = dateStr;
        }
        
        var printWindow = window.open('', '_blank');
        var content = printContent.innerHTML;
        
        var ticketStyles = '<style>' +
            '@page {' +
            '    size: 80mm auto;' +
            '    margin: 5mm;' +
            '}' +
            '* {' +
            '    margin: 0;' +
            '    padding: 0;' +
            '    box-sizing: border-box;' +
            '}' +
            'body {' +
            '    margin: 0;' +
            '    padding: 8px;' +
            '    font-family: "Courier New", monospace;' +
            '    font-size: 11px;' +
            '    width: 80mm;' +
            '    background: white;' +
            '}' +
            '.ticket-slip {' +
            '    width: 100%;' +
            '    max-width: 70mm;' +
            '    margin: 0 auto;' +
            '    padding: 5px;' +
            '    border: 1px dashed #ccc;' +
            '}' +
            '.ticket-header {' +
            '    text-align: center;' +
            '    margin-bottom: 5px;' +
            '}' +
            '.ticket-title {' +
            '    font-size: 14px;' +
            '    font-weight: bold;' +
            '    letter-spacing: 1px;' +
            '    margin-bottom: 2px;' +
            '}' +
            '.ticket-subtitle {' +
            '    font-size: 9px;' +
            '    color: #666;' +
            '}' +
            '.ticket-divider {' +
            '    text-align: center;' +
            '    color: #ccc;' +
            '    font-size: 9px;' +
            '    margin: 5px 0;' +
            '    letter-spacing: 1px;' +
            '}' +
            '.ticket-content {' +
            '    margin: 5px 0;' +
            '}' +
            '.ticket-row {' +
            '    display: flex;' +
            '    justify-content: space-between;' +
            '    margin: 4px 0;' +
            '    font-size: 10px;' +
            '}' +
            '.ticket-row.highlight {' +
            '    margin: 6px 0;' +
            '}' +
            '.ticket-label {' +
            '    font-weight: bold;' +
            '    min-width: 60px;' +
            '}' +
            '.ticket-value {' +
            '    text-align: right;' +
            '}' +
            '.ticket-value-bold {' +
            '    text-align: right;' +
            '    font-weight: bold;' +
            '}' +
            '.balance-row {' +
            '    margin-top: 8px;' +
            '    padding-top: 5px;' +
            '    border-top: 1px dashed #ccc;' +
            '}' +
            '.ticket-value-balance {' +
            '    font-weight: bold;' +
            '    font-size: 12px;' +
            '    text-align: right;' +
            '}' +
            '.ticket-footer {' +
            '    text-align: center;' +
            '    margin-top: 10px;' +
            '    padding-top: 5px;' +
            '}' +
            '.ticket-date {' +
            '    margin-bottom: 3px;' +
            '    color: #666;' +
            '}' +
            '.ticket-thank {' +
            '    font-weight: bold;' +
            '    margin-top: 3px;' +
            '}' +
            '.ticket-cut-line {' +
            '    text-align: center;' +
            '    color: #999;' +
            '    font-size: 8px;' +
            '    margin-top: 8px;' +
            '    padding-top: 5px;' +
            '    border-top: 1px dashed #ccc;' +
            '}' +
            '@media print {' +
            '    body {' +
            '        margin: 0;' +
            '        padding: 5mm;' +
            '    }' +
            '    .ticket-slip {' +
            '        border: none;' +
            '        padding: 0;' +
            '    }' +
            '    .ticket-cut-line {' +
            '        page-break-after: always;' +
            '    }' +
            '}' +
            '</style>';
        
        printWindow.document.write('<!DOCTYPE html><html><head><title>Sale Receipt</title><meta charset="UTF-8">');
        printWindow.document.write(ticketStyles);
        printWindow.document.write('</head><body>');
        printWindow.document.write(content);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        
        printWindow.onload = function() {
            setTimeout(function() {
                printWindow.print();
                setTimeout(function() {
                    printWindow.close();
                }, 100);
            }, 250);
        };
    }
    
    $(document).ready(function() {
        $('.print-sale-btn').on('click', function() {
            var saleId = $(this).data('sale-id');
            printSaleRecord(saleId);
        });
    });
</script>
{% endblock %}
