{% extends 'dairyapp/base.html' %}

{% load static %}
 {% load widget_tweaks %}

{% block extra-css %}
    <style>
        .myfont{
            font-size: 18px;


        }

        tr:hover{

            font-weight: bolder;
        }
    </style>

{% endblock %}
{% block main-content %}



    <div class="row myfont" style="padding-left: 15px;">
        <div class="col-lg-4">
            <h2>Buy Milk दुध खरिद</h2>

            <form class="form-horizontal" method="POST" enctype="multipart/form-data">
                {% csrf_token %}

                {{ form.non_field_errors }}

                {% for hidden_field in form.hidden_fields %}
                    {{ hidden_field }}
                {% endfor %}

                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {% for error in form.non_field_errors %}
                            {{ error }}

                        {% endfor %}
                    </div>
                {% endif %}

                {% for field in form %}

                    <div class="form-group">

                        {{ field.label_tag }}
                        {% if form.is_bound %}
                            {% if field.errors %}

                                {% render_field field class="form-control is-invalid"%}

                                {% for error in field.errors %}
                                    <div class="invalid-feedback text-danger">
                                         {{ error }}
                                    </div>
                                {% endfor %}

                            {% else %}
                                   {% render_field field class="form-control is-valid" %}
                            {% endif %}

                        {% else %}
                               {% render_field field class="form-control" %}
                        {% endif %}

                    {% if field.help_text %}

                        <small class="form-text text-primary">{{ field.help_text }}</small>
                    {% endif %}

                    </div>
                {% endfor %}



                <div class="form-group">
                    <div class="col-sm-12" onclick="if (!confirm('Are you sure?')) { return false }">
                         <button type="submit" class="btn btn-primary btn-block" >
                             <strong>Add to Purchase</strong>
                         </button>
                    </div>
                 </div>

            </form>

        </div>

        <div class="col-lg-8">
            <h2>Showing Latest Milk Purchase  दुध खरिद</h2>


            <!-- Milk Purchase list for today -->
            <div class="table-responsive" style="overflow-x: auto;">
              <table class="table table-striped table-hover table-responsive" style="font-size: 12px;">
                <thead>
                  <tr class="bg-success">
                    <th>SN.</th>
                    <th>Date</th>
                    <th>Seller</th>
                    <th>Qty L.</th>
                    <th>Fat</th>
                    <th>SNF</th>
                    <th>Fat/Kg.</th>
                    <th>SNF/Kg.</th>
                    <th>Rate</th>
                    <th>TS</th>
                    <th>Ts Amount</th>
                    <th>Rate/ltr</th>
                    <th>Total Amount</th>
                    <th>Advance</th>
                    <th>Remaining</th>
                    <th>Remarks</th>
                    <th>Actions</th>
                  </tr>
                </thead>

                <tbody class="active">
                    {% for purchase in milk %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ purchase.mPurchase_date|date:"d/m/Y" }}</td>
                            <td>{{ purchase.seller }}</td>
                            <td>{{ purchase.mPurchase_qty|floatformat:2 }}</td>
                            <td>{% if purchase.fat %}{{ purchase.fat|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.snf %}{{ purchase.snf|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.fat_per_kg %}{{ purchase.fat_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.snf_per_kg %}{{ purchase.snf_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.rate %}{{ purchase.rate|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.ts %}{{ purchase.ts|floatformat:4 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.ts_amount %}{{ purchase.ts_amount|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.rate_per_ltr %}{{ purchase.rate_per_ltr|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{{ purchase.mPurchase_total|floatformat:2 }}</td>
                            <td>{% if purchase.advance_amount %}{{ purchase.advance_amount|floatformat:2 }}{% else %}0.00{% endif %}</td>
                            <td>
                                <span class="{% if purchase.remaining_balance > 0 %}text-danger{% elif purchase.remaining_balance < 0 %}text-success{% else %}text-muted{% endif %}" style="font-weight: bold;">
                                    {{ purchase.remaining_balance|floatformat:2 }}
                                </span>
                            </td>
                            <td style="max-width: 150px; word-wrap: break-word; font-size: 11px;">
                                {% if purchase.remarks %}{{ purchase.remarks|truncatewords:10 }}{% else %}-{% endif %}
                            </td>
                            <td>
                                <div style="display: flex; gap: 5px;">
                                    <button type="button" class="btn btn-info btn-sm" onclick="printPurchaseRecord({{ purchase.mPurchase_id }})" title="Print">
                                        <i class="fa fa-print"></i> Print
                                    </button>
                                    <a class="btn btn-danger btn-sm" href="{% url 'dairyapp:delete-purchase' id=purchase.mPurchase_id %}" onclick="return confirm('Do you want to confirm?')" title="Delete">
                                        <i class="fa fa-times"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                    {% if milk and totals %}
                    <tr class="bg-warning" style="font-weight: bold;">
                        <td colspan="3"><strong>Total</strong></td>
                        <td><strong>{{ totals.total_qty|floatformat:2 }}</strong></td>
                        <td colspan="2">-</td>
                        <td colspan="2">-</td>
                        <td>-</td>
                        <td>-</td>
                        <td><strong>{{ totals.total_ts_amount|floatformat:2 }}</strong></td>
                        <td>-</td>
                        <td><strong>{{ totals.total_amount|floatformat:2 }}</strong></td>
                        <td><strong>{{ totals.total_advance|floatformat:2 }}</strong></td>
                        <td>-</td>
                        <td>-</td>
                        <td></td>
                    </tr>
                    {% endif %}
                </tbody>
              </table>

            {% if milk.has_other_pages %}
                <ul class="pagination">
                    {% if milk.has_previous %}
                        <li>
                            <a href="?page={{ milk.previous_page_number }}">&laquo;</a>
                        </li>
                    {% else %}
                        <li class="disabled">
                            <span>&laquo;</span>
                        </li>
                    {% endif %}
                    {% for i in milk.paginator.page_range %}
                        {% if milk.number == i %}
                            <li class="active">
                                <span>{{ i }}
                                <span class="sr-only">(current)</span>
                                </span>
                            </li>
                        {% else %}
                            <li>
                                <a href="?page={{ i }}">{{ i }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}

                    {% if milk.has_next %}
                        <li>
                            <a href="?page={{ milk.next_page_number }}">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="disabled">
                            <span>&raquo;</span>
                        </li>
                    {% endif %}

                </ul>
            {% endif %}





            </div>
        </div>
    </div>

    <!-- Print content for each purchase record -->
    {% for purchase in milk %}
    <div id="printContent-{{ purchase.mPurchase_id }}" class="print-content" style="display: none;">
        <div class="ticket-slip">
            <div class="ticket-header">
                <div class="ticket-title">MILK PURCHASE RECEIPT</div>
                <div class="ticket-subtitle">Dairy Management System</div>
            </div>
            
            <div class="ticket-divider">--------------------------------</div>
            
            <div class="ticket-content">
                <div class="ticket-row">
                    <span class="ticket-label">ID:</span>
                    <span class="ticket-value">#{{ purchase.mPurchase_id }}</span>
                </div>
                
                <div class="ticket-row">
                    <span class="ticket-label">Date:</span>
                    <span class="ticket-value">{{ purchase.mPurchase_date|date:"Y-m-d" }}</span>
                </div>
                
                <div class="ticket-divider">--------------------------------</div>
                
                <div class="ticket-row highlight">
                    <span class="ticket-label">Seller:</span>
                    <span class="ticket-value-bold">{{ purchase.seller }}</span>
                </div>
                
                <div class="ticket-divider">--------------------------------</div>
                
                <div class="ticket-row">
                    <span class="ticket-label">Quantity:</span>
                    <span class="ticket-value">{{ purchase.mPurchase_qty|floatformat:2 }} ltr</span>
                </div>
                
                {% if purchase.fat %}
                <div class="ticket-row">
                    <span class="ticket-label">Fat:</span>
                    <span class="ticket-value">{{ purchase.fat|floatformat:2 }}%</span>
                </div>
                {% endif %}
                
                {% if purchase.snf %}
                <div class="ticket-row">
                    <span class="ticket-label">SNF:</span>
                    <span class="ticket-value">{{ purchase.snf|floatformat:2 }}%</span>
                </div>
                {% endif %}
                
                {% if purchase.fat_per_kg %}
                <div class="ticket-row">
                    <span class="ticket-label">Fat/Kg:</span>
                    <span class="ticket-value">{{ purchase.fat_per_kg|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                {% if purchase.snf_per_kg %}
                <div class="ticket-row">
                    <span class="ticket-label">SNF/Kg:</span>
                    <span class="ticket-value">{{ purchase.snf_per_kg|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                {% if purchase.rate %}
                <div class="ticket-row">
                    <span class="ticket-label">Rate:</span>
                    <span class="ticket-value">{{ purchase.rate|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                {% if purchase.ts %}
                <div class="ticket-row">
                    <span class="ticket-label">TS:</span>
                    <span class="ticket-value">{{ purchase.ts|floatformat:4 }}</span>
                </div>
                {% endif %}
                
                {% if purchase.ts_amount %}
                <div class="ticket-row">
                    <span class="ticket-label">TS Amount:</span>
                    <span class="ticket-value">NRs. {{ purchase.ts_amount|floatformat:2 }}</span>
                </div>
                {% endif %}
                
                {% if purchase.rate_per_ltr %}
                <div class="ticket-row">
                    <span class="ticket-label">Rate/Ltr:</span>
                    <span class="ticket-value">NRs. {{ purchase.rate_per_ltr|floatformat:3 }}</span>
                </div>
                {% endif %}
                
                <div class="ticket-divider">--------------------------------</div>
                
                <div class="ticket-row balance-row">
                    <span class="ticket-label">Total Amount:</span>
                    <span class="ticket-value-balance">NRs. {{ purchase.mPurchase_total|floatformat:2 }}</span>
                </div>
                
                {% if purchase.remarks %}
                <div class="ticket-divider">--------------------------------</div>
                <div class="ticket-row">
                    <span class="ticket-label">Remarks:</span>
                    <span class="ticket-value-small">{{ purchase.remarks }}</span>
                </div>
                {% endif %}
            </div>
            
            <div class="ticket-divider">--------------------------------</div>
            
            <div class="ticket-footer">
                <div class="ticket-date">Printed: <span id="printDate-{{ purchase.mPurchase_id }}"></span></div>
                <div class="ticket-thank">Thank You!</div>
            </div>
            
            <div class="ticket-cut-line">━━━━━━━━━━━━━━━━━━━━━━━━━━</div>
        </div>
    </div>
    {% endfor %}

{% endblock %}

{% block extra-js %}
<script>

        $('#nepalicalendar').nepaliDatePicker({
            onFocus:false,
            ndpTriggerButton: true,
            ndpTriggerButtonText: 'Date',
            npdMonth:true,
            npdYearCount:10,
            ndpTriggerButtonClass: 'btn btn-primary btn-sm',
            /*disableBefore:'03/05/2075', //MM/DD/YYYY */
            disableDaysAfter:'1'

        });

    function printPurchaseRecord(purchaseId) {
        var printContent = document.getElementById('printContent-' + purchaseId);
        var printDate = document.getElementById('printDate-' + purchaseId);
        
        if (!printContent) {
            alert('Print content not found!');
            return;
        }
        
        if (printDate) {
            var now = new Date();
            var dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            printDate.textContent = dateStr;
        }
        
        var printWindow = window.open('', '_blank');
        var content = printContent.innerHTML;
        
        var ticketStyles = `
            <style>
                @page {
                    size: 80mm auto;
                    margin: 5mm;
                }
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }
                body {
                    margin: 0;
                    padding: 8px;
                    font-family: 'Courier New', monospace;
                    font-size: 11px;
                    width: 80mm;
                    background: white;
                }
                .ticket-slip {
                    width: 100%;
                    max-width: 70mm;
                    margin: 0 auto;
                    padding: 5px;
                    border: 1px dashed #ccc;
                }
                .ticket-header {
                    text-align: center;
                    margin-bottom: 5px;
                }
                .ticket-title {
                    font-size: 14px;
                    font-weight: bold;
                    letter-spacing: 1px;
                    margin-bottom: 2px;
                }
                .ticket-subtitle {
                    font-size: 9px;
                    color: #666;
                }
                .ticket-divider {
                    text-align: center;
                    color: #ccc;
                    font-size: 9px;
                    margin: 5px 0;
                    letter-spacing: 1px;
                }
                .ticket-content {
                    margin: 5px 0;
                }
                .ticket-row {
                    display: flex;
                    justify-content: space-between;
                    margin: 4px 0;
                    font-size: 10px;
                }
                .ticket-row.highlight {
                    margin: 6px 0;
                }
                .ticket-label {
                    font-weight: bold;
                    min-width: 60px;
                }
                .ticket-value {
                    text-align: right;
                    flex: 1;
                }
                .ticket-value-bold {
                    text-align: right;
                    flex: 1;
                    font-weight: bold;
                    font-size: 11px;
                }
                .ticket-value-balance {
                    text-align: right;
                    flex: 1;
                    font-weight: bold;
                    font-size: 12px;
                }
                .balance-row {
                    margin-top: 8px;
                    padding-top: 5px;
                    border-top: 1px dashed #ccc;
                }
                .ticket-footer {
                    text-align: center;
                    margin-top: 5px;
                    font-size: 9px;
                }
                .ticket-date {
                    margin-bottom: 3px;
                    color: #666;
                }
                .ticket-thank {
                    font-weight: bold;
                    margin-top: 3px;
                }
                .ticket-cut-line {
                    text-align: center;
                    color: #999;
                    font-size: 8px;
                    margin-top: 8px;
                    padding-top: 5px;
                    border-top: 1px dashed #ccc;
                }
                @media print {
                    body {
                        margin: 0;
                        padding: 5mm;
                    }
                    .ticket-slip {
                        border: none;
                        padding: 0;
                    }
                    .ticket-cut-line {
                        page-break-after: always;
                    }
                }
            </style>
        `;
        
        printWindow.document.write('<!DOCTYPE html><html><head><title>Purchase Receipt</title><meta charset="UTF-8">');
        printWindow.document.write(ticketStyles);
        printWindow.document.write('</head><body>');
        printWindow.document.write(content);
        printWindow.document.write('</body></html>');
        printWindow.document.close();
        
        printWindow.onload = function() {
            setTimeout(function() {
                printWindow.print();
                setTimeout(function() {
                    printWindow.close();
                }, 100);
            }, 250);
        };
    }

</script>

{% endblock %}