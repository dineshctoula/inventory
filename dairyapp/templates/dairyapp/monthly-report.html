{% extends 'dairyapp/base.html' %}
{% load static %}
{% block extra-css %}
<style>
    @media print {
        @page {
            margin: 0;
            size: A4;
        }
        body {
            margin: 0;
            padding: 0;
        }
        body * {
            visibility: hidden;
        }
        .print-container, .print-container * {
            visibility: visible;
        }
        .print-container {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            margin: 0;
            padding: 10mm;
        }
        .no-print {
            display: none !important;
        }
        a[href]:after {
            content: none !important;
        }
    }
    
    .print-container {
        font-family: 'Times New Roman', serif;
        width: 210mm;
        margin: 0 auto;
        padding: 10mm;
        background: white;
    }
    
    .report-header {
        margin-bottom: 15px;
        text-align: center;
        width: 100%;
    }
    
    .company-name {
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 5px;
        letter-spacing: 1px;
    }
    
    .company-address {
        font-size: 12px;
        text-align: center;
        margin-bottom: 3px;
    }
    
    .pan-number {
        font-size: 11px;
        text-align: center;
        margin-bottom: 10px;
    }
    
    .party-info {
        margin-top: 10px;
        margin-bottom: 15px;
        text-align: center;
    }
    
    .party-name {
        font-size: 14px;
        font-weight: bold;
        text-align: center;
        margin-bottom: 3px;
    }
    
    .party-address {
        font-size: 12px;
        text-align: center;
        margin-bottom: 10px;
    }
    
    .summary-box {
        border: 1px solid #000;
        padding: 8px;
        width: 150px;
        font-size: 11px;
        margin: 10px auto;
        text-align: left;
    }
    
    .summary-row {
        margin: 3px 0;
        display: flex;
        justify-content: space-between;
    }
    
    .summary-label {
        font-weight: bold;
    }
    
    .report-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
        margin-top: 10px;
    }
    
    .report-table th {
        border: 1px solid #000;
        padding: 5px 3px;
        text-align: center;
        background-color: #f0f0f0;
        font-weight: bold;
    }
    
    .report-table td {
        border: 1px solid #000;
        padding: 4px 3px;
        text-align: right;
    }
    
    .report-table td.text-left {
        text-align: left;
    }
    
    .report-table td.text-center {
        text-align: center;
    }
    
    .total-row {
        font-weight: bold;
        background-color: #e8e8e8;
    }
    
    .total-row td {
        text-align: right;
    }
    
    .total-row td:first-child {
        text-align: center;
        font-weight: bold;
    }
    
    .form-container {
        background: #f5f5f5;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 5px;
    }
    
    .months-list {
        margin-top: 20px;
        padding: 15px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .months-list h4 {
        margin-bottom: 15px;
        color: #333;
    }
    
    .month-item {
        display: inline-block;
        margin: 5px;
        padding: 10px 15px;
        background: #5cb85c;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        text-decoration: none;
        font-weight: bold;
    }
    
    .month-item:hover {
        background: #449d44;
        color: white;
        text-decoration: none;
    }
    
    .month-count {
        font-size: 0.85em;
        opacity: 0.9;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block main-content %}
<div class="no-print">
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <h2><strong>Monthly Purchase Report</strong></h2>
            
            <div class="form-container">
                <form method="POST" class="form-horizontal">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label>{{ form.seller.label }}</label>
                                {{ form.seller }}
                                {% if form.seller.errors %}
                                    <div class="text-danger">{{ form.seller.errors }}</div>
                                {% endif %}
                                {% if form.seller.help_text %}
                                    <small class="form-text text-muted">{{ form.seller.help_text }}</small>
                                {% endif %}
                                <a href="{% url 'dairyapp:sellers' %}" class="btn btn-sm btn-link" style="padding: 0; margin-top: 5px;">
                                    <i class="fa fa-plus"></i> Add New Seller
                                </a>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>{{ form.report_date.label }}</label>
                                {{ form.report_date }}
                                {% if form.report_date.errors %}
                                    <div class="text-danger">{{ form.report_date.errors }}</div>
                                {% endif %}
                                {% if form.report_date.help_text %}
                                    <small class="form-text text-muted">{{ form.report_date.help_text }}</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-2">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <button type="submit" class="btn btn-primary btn-block">View Purchases</button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

{% if purchases %}
<!-- Purchase List Table (similar to purchase page) - Shows immediately -->
<div class="no-print" style="margin-top: 30px;">
    <div class="row">
        <div class="col-lg-12">
            <h3><strong>Purchase Records for {{ seller_name }} - {% if nepali_month_name and nepali_year %}{{ nepali_month_name }} {{ nepali_year }}{% elif month_name %}{{ month_name }} {{ year }}{% elif month %}{{ month }}/{{ year }}{% endif %}</strong></h3>
            <p class="text-muted">Showing latest purchases for the selected month (max 100 records)</p>
            
            <div class="table-responsive" style="overflow-x: auto; margin-top: 20px;">
                <table class="table table-striped table-hover" style="font-size: 12px;">
                    <thead>
                        <tr class="bg-success">
                            <th>SN.</th>
                            <th>Date</th>
                            <th>Qty L.</th>
                            <th>Fat</th>
                            <th>SNF</th>
                            <th>Fat/Kg.</th>
                            <th>SNF/Kg.</th>
                            <th>Rate</th>
                            <th>TS</th>
                            <th>Ts Amount</th>
                            <th>Rate/ltr</th>
                            <th>Total Amount</th>
                            <th>Advance</th>
                            <th>Remaining</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for purchase in purchases %}
                        <tr>
                            <td>{{ forloop.counter }}</td>
                            <td>{{ purchase.mPurchase_date|date:"d/m/Y" }}</td>
                            <td>{{ purchase.mPurchase_qty|floatformat:2 }}</td>
                            <td>{% if purchase.fat %}{{ purchase.fat|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.snf %}{{ purchase.snf|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.fat_per_kg %}{{ purchase.fat_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.snf_per_kg %}{{ purchase.snf_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.rate %}{{ purchase.rate|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.ts %}{{ purchase.ts|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.ts_amount %}{{ purchase.ts_amount|floatformat:2 }}{% else %}-{% endif %}</td>
                            <td>{% if purchase.rate_per_ltr %}{{ purchase.rate_per_ltr|floatformat:3 }}{% else %}-{% endif %}</td>
                            <td>{{ purchase.mPurchase_total|floatformat:2 }}</td>
                            <td>{% if purchase.advance_amount %}{{ purchase.advance_amount|floatformat:2 }}{% else %}0.00{% endif %}</td>
                            <td>
                                <span class="{% if purchase.remaining_balance > 0 %}text-danger{% elif purchase.remaining_balance < 0 %}text-success{% else %}text-muted{% endif %}" style="font-weight: bold;">
                                    {{ purchase.remaining_balance|floatformat:2 }}
                                </span>
                            </td>
                            <td>
                                <button type="button" class="btn btn-info btn-sm" onclick="printPurchaseRecord({{ purchase.mPurchase_id }})" title="Print">
                                    <i class="fa fa-print"></i> Print
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% if totals %}
                        <tr class="bg-warning" style="font-weight: bold;">
                            <td colspan="2"><strong>Total (Current Page)</strong></td>
                            <td><strong>{{ totals.total_qty|floatformat:2 }}</strong></td>
                            <td colspan="2">-</td>
                            <td colspan="2">-</td>
                            <td>-</td>
                            <td>-</td>
                            <td><strong>{{ totals.total_ts_amount|floatformat:2 }}</strong></td>
                            <td>-</td>
                            <td><strong>{{ totals.total_amount|floatformat:2 }}</strong></td>
                            <td><strong>{{ totals.total_advance|floatformat:2 }}</strong></td>
                            <td>-</td>
                            <td></td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            {% if purchases.has_other_pages %}
                <ul class="pagination">
                    {% if purchases.has_previous %}
                        <li><a href="?page={{ purchases.previous_page_number }}">&laquo;</a></li>
                    {% else %}
                        <li class="disabled"><span>&laquo;</span></li>
                    {% endif %}
                    {% for i in purchases.paginator.page_range %}
                        {% if purchases.number == i %}
                            <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                        {% else %}
                            <li><a href="?page={{ i }}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}
                    {% if purchases.has_next %}
                        <li><a href="?page={{ purchases.next_page_number }}">&raquo;</a></li>
                    {% else %}
                        <li class="disabled"><span>&raquo;</span></li>
                    {% endif %}
                </ul>
            {% endif %}
            
            <!-- Generate PDF Report Button -->
            <div style="margin-top: 20px; text-align: center;">
                <button onclick="generateMonthlyReport()" class="btn btn-success btn-lg">
                    <i class="fa fa-file-pdf-o"></i> Generate Monthly Report (PDF Format)
                </button>
            </div>
        </div>
    </div>
</div>

<!-- PDF Report Section (Hidden until Generate Report is clicked) -->
<div id="pdfReportSection" class="print-container" style="display: none;">
    <!-- Header Section -->
    <div class="report-header">
        <div class="company-name">MANARAM HIMALAYAN HANDICRAFT PVT. LTD.</div>
        <div class="company-address">BIRTAMOD-10, JHAPA</div>
        <div class="pan-number">PAN: 301418625</div>
        <div class="party-info">
            <div class="party-name">PARTY'S NAME:-{{ seller_name }}</div>
            <div class="party-address">District Jhapa ,Nepal</div>
        </div>
        <div class="summary-box">
            <div class="summary-row">
                <span class="summary-label">Fat Rate/kg:</span>
                <span>{{ summary_rates.fat_rate_per_kg|floatformat:2 }}</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">SNF Rate/Kgs:</span>
                <span>{{ summary_rates.snf_rate_per_kg|floatformat:2 }}</span>
            </div>
            <div class="summary-row">
                <span class="summary-label">Total Solids/Kgs:</span>
                <span>{{ summary_rates.total_solids_per_kg|floatformat:0 }}%</span>
            </div>
        </div>
    </div>
    
    <!-- Table Section -->
    <table class="report-table">
        <thead>
            <tr>
                <th style="width: 3%;">SN.</th>
                <th style="width: 8%;">Date</th>
                <th style="width: 8%;">Qty L.</th>
                <th style="width: 5%;">Fat</th>
                <th style="width: 5%;">SNF</th>
                <th style="width: 7%;">Fat/Kg.</th>
                <th style="width: 7%;">SNF/Kg.</th>
                <th style="width: 7%;">Rate</th>
                <th style="width: 6%;">TS</th>
                <th style="width: 9%;">Ts Amount</th>
                <th style="width: 8%;">Rate/ltr</th>
                <th style="width: 11%;">Total Amount</th>
            </tr>
        </thead>
        <tbody>
            {% for purchase in purchases %}
            <tr>
                <td class="text-center">{{ forloop.counter }}</td>
                <td class="text-center">{{ purchase.mPurchase_date|date:"d/m/Y" }}</td>
                <td>{{ purchase.mPurchase_qty|floatformat:2 }}</td>
                <td>{% if purchase.fat %}{{ purchase.fat|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if purchase.snf %}{{ purchase.snf|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if purchase.fat_per_kg %}{{ purchase.fat_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                <td>{% if purchase.snf_per_kg %}{{ purchase.snf_per_kg|floatformat:3 }}{% else %}-{% endif %}</td>
                <td>{% if purchase.rate %}{{ purchase.rate|floatformat:3 }}{% else %}-{% endif %}</td>
                <td>{% if purchase.ts %}{{ purchase.ts|floatformat:3 }}{% else %}-{% endif %}</td>
                <td>{% if purchase.ts_amount %}{{ purchase.ts_amount|floatformat:2 }}{% else %}-{% endif %}</td>
                <td>{% if purchase.rate_per_ltr %}{{ purchase.rate_per_ltr|floatformat:3 }}{% else %}-{% endif %}</td>
                <td>{{ purchase.mPurchase_total|floatformat:2 }}</td>
            </tr>
            {% endfor %}
            
            <!-- Total Row -->
            {% if totals %}
            <tr class="total-row">
                <td class="text-center" colspan="2"><strong>Total</strong></td>
                <td><strong>{{ totals.total_qty|floatformat:2 }}</strong></td>
                <td colspan="2">-</td>
                <td colspan="2">-</td>
                <td>-</td>
                <td>-</td>
                <td><strong>{{ totals.total_ts_amount|floatformat:2 }}</strong></td>
                <td>-</td>
                <td><strong>{{ totals.total_amount|floatformat:2 }}</strong></td>
            </tr>
            {% endif %}
        </tbody>
    </table>
    
    <div class="no-print" style="margin-top: 20px; text-align: center;">
        <button onclick="window.print()" class="btn btn-success btn-lg">
            <i class="fa fa-print"></i> Print Report
        </button>
    </div>
</div>
{% endif %}

<!-- Print content for each purchase record (from purchase page) -->
{% if purchases %}
{% for purchase in purchases %}
<div id="printContent-{{ purchase.mPurchase_id }}" class="print-content" style="display: none;">
    <div class="ticket-slip">
        <div class="ticket-header">
            <div class="ticket-title">MILK PURCHASE RECEIPT</div>
            <div class="ticket-subtitle">Dairy Management System</div>
        </div>
        
        <div class="ticket-divider">--------------------------------</div>
        
        <div class="ticket-content">
            <div class="ticket-row">
                <span class="ticket-label">Date:</span>
                <span class="ticket-value">{{ purchase.mPurchase_date|date:"d/m/Y" }}</span>
            </div>
            <div class="ticket-row">
                <span class="ticket-label">Seller:</span>
                <span class="ticket-value-bold">{{ purchase.seller }}</span>
            </div>
            <div class="ticket-row">
                <span class="ticket-label">Qty (Liters):</span>
                <span class="ticket-value">{{ purchase.mPurchase_qty|floatformat:2 }}</span>
            </div>
            {% if purchase.fat %}
            <div class="ticket-row">
                <span class="ticket-label">Fat (%):</span>
                <span class="ticket-value">{{ purchase.fat|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if purchase.snf %}
            <div class="ticket-row">
                <span class="ticket-label">SNF (%):</span>
                <span class="ticket-value">{{ purchase.snf|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if purchase.mPurchase_total %}
            <div class="ticket-row">
                <span class="ticket-label">Total Amount:</span>
                <span class="ticket-value-bold">NRs. {{ purchase.mPurchase_total|floatformat:2 }}</span>
            </div>
            {% endif %}
            {% if purchase.advance_amount %}
            <div class="ticket-row">
                <span class="ticket-label">Advance:</span>
                <span class="ticket-value">NRs. {{ purchase.advance_amount|floatformat:2 }}</span>
            </div>
            {% endif %}
        </div>
        
        <div class="ticket-divider">--------------------------------</div>
        <div class="ticket-footer" id="printDate-{{ purchase.mPurchase_id }}"></div>
    </div>
</div>
{% endfor %}
{% endif %}

{% endblock %}

{% block extra-js %}
<script>
    $('#nepalicalendar_monthly').nepaliDatePicker({
        onFocus: true,
        ndpTriggerButton: false,
        npdMonth: true,
        npdYearCount: 10,
        disableDaysAfter: '1'
    });
    
    function generateMonthlyReport() {
        var pdfSection = document.getElementById('pdfReportSection');
        if (pdfSection) {
            var originalTitle = document.title;
            document.title = 'Monthly Purchase Report';
            pdfSection.style.display = 'block';
            window.print();
            pdfSection.style.display = 'none';
            document.title = originalTitle;
        } else {
            window.print();
        }
    }
    
    function printPurchaseRecord(purchaseId) {
        var printContent = document.getElementById('printContent-' + purchaseId);
        var printDate = document.getElementById('printDate-' + purchaseId);
        
        if (!printContent) {
            alert('Print content not found!');
            return;
        }
        
        if (printDate) {
            var now = new Date();
            var dateStr = now.toLocaleDateString() + ' ' + now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            printDate.textContent = 'Printed: ' + dateStr;
        }
        
        var printWindow = window.open('', '_blank');
        var content = printContent.innerHTML;
        
        var ticketStyles = `
            <style>
                @media print {
                    body { margin: 0; padding: 0; }
                    .ticket-slip { width: 80mm; margin: 0 auto; }
                }
                .ticket-slip {
                    width: 80mm;
                    margin: 0 auto;
                    padding: 10px;
                    font-family: Arial, sans-serif;
                    font-size: 12px;
                    border: 1px dashed #ccc;
                }
                .ticket-header {
                    text-align: center;
                    margin-bottom: 10px;
                }
                .ticket-title {
                    font-weight: bold;
                    font-size: 14px;
                    margin-bottom: 3px;
                }
                .ticket-subtitle {
                    font-size: 10px;
                    color: #666;
                }
                .ticket-divider {
                    text-align: center;
                    margin: 8px 0;
                    font-size: 10px;
                }
                .ticket-content {
                    margin: 10px 0;
                }
                .ticket-row {
                    display: flex;
                    justify-content: space-between;
                    margin: 5px 0;
                    font-size: 11px;
                }
                .ticket-label {
                    font-weight: bold;
                }
                .ticket-value {
                    text-align: right;
                }
                .ticket-value-bold {
                    text-align: right;
                    font-weight: bold;
                }
                .ticket-footer {
                    text-align: center;
                    font-size: 9px;
                    color: #666;
                    margin-top: 10px;
                }
            </style>
        `;
        
        printWindow.document.write(ticketStyles + content);
        printWindow.document.close();
        printWindow.focus();
        setTimeout(function() {
            printWindow.print();
            printWindow.close();
        }, 250);
    }
</script>
{% endblock %}

